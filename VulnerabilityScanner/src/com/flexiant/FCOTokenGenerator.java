package com.flexiant;

import java.net.URL;
import java.util.List;

import javax.xml.namespace.QName;
import javax.xml.ws.BindingProvider;

import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;

import com.extl.jade.admin.AdminAPI;
import com.extl.jade.admin.AdminService;
import com.extl.jade.admin.AuthenticationToken;
import com.extl.jade.admin.Condition;
import com.extl.jade.admin.CustomerDetails;
import com.extl.jade.admin.ExtilityException;
import com.extl.jade.admin.FilterCondition;
import com.extl.jade.admin.ListResult;
import com.extl.jade.admin.QueryLimit;
import com.extl.jade.admin.ResourceType;
import com.extl.jade.admin.SearchFilter;
import com.extl.jade.admin.Server;
import com.extl.jade.admin.UserDetails;


public class FCOTokenGenerator {
	public String tokenID;

	private static Logger LOGGER = LogManager.getLogger(FCOTokenGenerator.class);

    public void tokenGenerator(String serverUUID) throws ExtilityException {
		LOGGER.info("Starting FCO API token generation");

	 String fcoendpoint = Globals.FCOAdminEndpoint;
   	 String fcousername = Globals.FCOCloudUsernameCredential;
   	 String fcopassword = Globals.FCOCloudPasswordCredential;
   	 String uuid = Globals.FCOCloudAdminUUID;
    		    	String assumedCustomerUUID ="";
    		    	String assumedusername = "";
    		    	AuthenticationToken token = null;  	
    		    	AdminService service;

        // Get the service WSDL from the client jar
        URL url = getClass().getClassLoader().getResource(
                "AdminAPI.wsdl");

        // Get the AdminAPI
        AdminAPI api = new AdminAPI(url,
                new QName("http://extility.flexiant.net", "AdminAPI"));
         
        // and set the service port on the service
        service = api.getAdminServicePort();
       
        // Get the binding provider
        BindingProvider portBP = (BindingProvider) service;
         
        // and set the service endpoint
        portBP.getRequestContext().put(BindingProvider.ENDPOINT_ADDRESS_PROPERTY,
        		fcoendpoint);
         
        // and the caller's authentication details and password
       portBP.getRequestContext().put(BindingProvider.USERNAME_PROPERTY,
    		   fcousername + "/" + uuid);
 
        portBP.getRequestContext().put(BindingProvider.PASSWORD_PROPERTY,
        		fcopassword);
   
             
        try {
        	  
            // Create an FQL filter and a filter condition
            SearchFilter sf = new SearchFilter();
            FilterCondition fc = new FilterCondition();
             
            // set the condition type
            fc.setCondition(Condition.IS_EQUAL_TO);
          
            // the field to be matched
            fc.setField("resourceuuid");
             
            // and a list of values
            fc.getValue().add(serverUUID);
             
            // Add the filter condition to the query
            sf.getFilterConditions().add(fc);
             
            // Set a limit to the number of results
            QueryLimit lim = new QueryLimit();
            lim.setMaxRecords(10);
   
            // Call the service to execute the query
            ListResult result = service.listResources(sf, lim, ResourceType.SERVER);
             
            // Iterate through the results   
            for(Object o : result.getList()) {
                Server s = ((Server)o);
                //Get customerUUID from VM uuid
                 assumedCustomerUUID = s.getCustomerUUID();
            
            }
          
        } catch (Exception e) {
             
        	LOGGER.error("Exception caught in FCO TokenGeneration: " + e.getMessage());
        }
        //Use this UUID to get first user within customer account
        	CustomerDetails c = service.getCustomer(assumedCustomerUUID);
            List<UserDetails> users = c.getUsers();
            assumedusername = (users.get(0).getEmail());
            //Use customer uuid and first user from customer account to generate token
            token = service.getAuthenticationToken(assumedusername, assumedCustomerUUID, (long) 180, true);     
            tokenID = token.getPublicToken();
			LOGGER.info("FCO API token  created successfully" + tokenID);

    }
  

}