package com.scanner;

import java.io.BufferedReader;
import java.io.FileInputStream;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.Properties;

import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;

import com.global.Globals;
import com.parser.FirewallConfigParser;

public class LoadProperties {

	private static Logger LOGGER = LogManager.getLogger(LoadProperties.class);
	private static Properties prop;
	private static String configFilename = "scannerConfig.properties";

	/*
	 * Method used for locating the path where the executable was launched in
	 * order to get the path of the config file
	 */
	public static String getPath() {
		String decodedPath = new java.io.File(
				ApplicationLauncher.class.getProtectionDomain().getCodeSource().getLocation().getPath())
						.getAbsolutePath();
		decodedPath = decodedPath.substring(0, decodedPath.lastIndexOf("."));
		decodedPath = decodedPath + System.getProperty("java.class.path");

		int index = decodedPath.lastIndexOf('/');
		decodedPath = decodedPath.substring(0, index);

		decodedPath = decodedPath + "/";
		return decodedPath;
	}

	// Read string from file
	static String readFile(String fileName) throws IOException {
		BufferedReader br = new BufferedReader(new FileReader(fileName));
		try {
			StringBuilder sb = new StringBuilder();
			String line = br.readLine();

			while (line != null) {
				sb.append(line);
				sb.append("\n");
				line = br.readLine();
			}
			return sb.toString();
		} finally {
			br.close();
		}
	}

	void loadProperties() {
		prop = new Properties();
		InputStreamReader in = null;
		try {

			// Retrieve config file path and load it
			String decodedPath = getPath() + configFilename;
			LOGGER.info("Path: " + decodedPath);

			if (decodedPath.equals("."))
				decodedPath = "/" + configFilename;

			in = new InputStreamReader(new FileInputStream(decodedPath), "UTF-8");
			prop.load(in);
			LOGGER.info("Config file loaded");
		} catch (IOException e) {
			e.printStackTrace();
			LOGGER.info("Error loading config");
		}
	}

	// Load key file from file
	public static String loadKeyFile(String keyFile) {
		String res = "";
		try {
			String path = keyFile;
			LOGGER.info("Keyfile path: " + path);
			res = readFile(path);
		} catch (IOException e) {
			LOGGER.error("Key file read exception: " + e.getMessage());
			LOGGER.error("Key file unable to be read.");
		}
		return res;
	}

	// Load AWS variabes from config file
	void loadAWSConfig() {

		Globals.AWSAccessKey = prop.getProperty("AWSAccessKey");
		Globals.AWSSecretKey = prop.getProperty("AWSSecretKey");
		Globals.AWSEndpoint = prop.getProperty("AWSEndpoint");
		Globals.AWSSSHKeyPath = prop.getProperty("AWSSSHKey");
		Globals.AWSSSHKey = prop.getProperty("AWSSSHKey");
		Globals.AWSScan = Boolean.valueOf(prop.getProperty("AWSScan"));
		Globals.AWSFirewall = Boolean.valueOf(prop.getProperty("AWSFirewall"));
		Globals.AWSChef = Boolean.valueOf(prop.getProperty("AWSChef"));
	}

	// Load openstack variabes from config file
	void loadOpenstackConfig() {

		Globals.OpenstackCloudUsernameCredential = prop.getProperty("OpenstackCloudUsername");
		Globals.OpenstackCloudPasswordCredential = prop.getProperty("OpenstackCloudPassword");
		Globals.OpenstackCloudTenant = prop.getProperty("OpenstackCloudTenant");
		Globals.OpenstackEndpoint = prop.getProperty("OpenstackEndpoint");
		Globals.OpenstackSSHKeyPath = prop.getProperty("OpenstackSSHKey");
		Globals.OpenstackSSHKey = prop.getProperty("OpenstackSSHKey");
		Globals.OpenstackScan = Boolean.valueOf(prop.getProperty("OpenstackScan"));
		Globals.OpenstackFirewall = Boolean.valueOf(prop.getProperty("OpenstackFirewall"));
		Globals.OpenstackChef = Boolean.valueOf(prop.getProperty("OpenstackChef"));

	}

	// Load open nebula variables from config file
	void loadOpenNebulaConfig() {

		Globals.OpenNebulaCloudUsernameCredential = prop.getProperty("OpenNebulaCloudUsername");
		Globals.OpenNebulaCloudPasswordCredential = prop.getProperty("OpenNebulaCloudPassword");
		Globals.OpenNebulaEndpoint = prop.getProperty("OpenNebulaEndpoint");
		Globals.OpenNebulaSSHKeyPath = prop.getProperty("OpenNebulaSSHKey");
		Globals.OpenNebulaSSHKey = prop.getProperty("OpenNebulaSSHKey");
		Globals.OpenNebulaScan = Boolean.valueOf(prop.getProperty("OpenNebulaScan"));
		Globals.OpenNebulaFirewall = Boolean.valueOf(prop.getProperty("OpenNebulaFirewall"));
		Globals.OpenNebulaChef = Boolean.valueOf(prop.getProperty("OpenNebulaChef"));

	}

	/* Method used to load credentials from a config file */
	void loadFCOConfig() {

		// Set global variables in order to access them later
		Globals.FCOCloudUsernameCredential = prop.getProperty("FCOCloudUsername");
		Globals.FCOCloudPasswordCredential = prop.getProperty("FCOCloudPassword");
		Globals.FCOCloudAdminUUID = prop.getProperty("FCOCloudAdminUUID");
		Globals.FCOAdminEndpoint = prop.getProperty("FCOAdminEndpoint");
		Globals.FCOSSHKeyPath = prop.getProperty("FCOSSHKey");
		Globals.FCOSSHKey = prop.getProperty("FCOSSHKey");
		Globals.FCOUserEndpoint = prop.getProperty("FCOUserEndpoint");
		Globals.FCOScan = Boolean.valueOf(prop.getProperty("FCOScan"));
		Globals.FCOFirewall = Boolean.valueOf(prop.getProperty("FCOFirewall"));
		Globals.FCOChef = Boolean.valueOf(prop.getProperty("FCOChef"));

	}

	// Load SSH Keys for each platform (if available)
	void loadKeys() {

		/*
		 * If the pem file is given as a file, load the private key from the
		 * file. Otherwise, it is assumed the key has been inputted in the
		 * config file
		 */
		Globals.FCOSSHKey = prop.getProperty("FCOSSHKey");
		if (Globals.FCOSSHKey.endsWith(".pem"))
			Globals.FCOSSHKey = loadKeyFile(Globals.FCOSSHKey);

		Globals.OpenstackSSHKey = prop.getProperty("OpenstackSSHKey");
		if (Globals.OpenstackSSHKey.endsWith(".pem"))
			Globals.OpenstackSSHKey = loadKeyFile(Globals.OpenstackSSHKey);

		Globals.OpenNebulaSSHKey = prop.getProperty("OpenNebulaSSHKey");
		if (Globals.OpenNebulaSSHKey.endsWith(".pem"))
			Globals.OpenNebulaSSHKey = loadKeyFile(Globals.OpenNebulaSSHKey);

		Globals.AWSSSHKey = prop.getProperty("AWSSSHKey");
		if (Globals.AWSSSHKey.endsWith(".pem"))
			Globals.AWSSSHKey = loadKeyFile(Globals.AWSSSHKey);
	}

	// Load chef knife executable location and chef repo location
	void loadChefConfig() {

		Globals.chefKnifeLocation = prop.getProperty("ChefKnifeLocation");
		Globals.chefRepoLocation = prop.getProperty("ChefRepoLocation");
	}

	void loadFirewallConfig() {

		Globals.firewallConfigFolder = prop.getProperty("FirewallConfigDirectory");
		FirewallConfigParser parser = new FirewallConfigParser();
		Globals.firewalls = parser.parseFiles();

	}
	
	void loadVMLogFileConfig(){
		
		if(prop.getProperty("VMInfoFilePath")!=null)
		Globals.vmInfoFilePath = prop.getProperty("VMInfoFilePath");
		
	}

}
